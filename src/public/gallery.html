<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>작업 갤러리 - Photo Factory</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <style>
    body {
      background: #f0f2f5;
      min-height: 100vh;
      padding-bottom: 50px;
    }

    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
    }

    .user-info img {
      border: 2px solid white;
    }

    .container-fluid {
      max-width: 1400px;
      margin-top: 30px;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-card p {
      color: #666;
      margin: 0;
    }

    .jobs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
    }

    .job-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s;
      cursor: pointer;
    }

    .job-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(102, 126, 234, 0.2);
    }

    .job-card-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f0f2f5;
    }

    .job-card-body {
      padding: 20px;
    }

    .job-number {
      font-size: 1.2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 10px;
    }

    .job-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .job-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .badge-photos {
      background: #e3f2fd;
      color: #1976d2;
    }

    .badge-date {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .fab-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.3s;
    }

    .fab-btn:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 5rem;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 100px 20px;
    }

    .loading .spinner-border {
      width: 3rem;
      height: 3rem;
      color: #667eea;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand text-white" href="/public/gallery.html">
        <i class="bi bi-images"></i> 작업 갤러리
      </a>
      <div id="userProfile" class="user-info"></div>
    </div>
  </nav>

  <div class="container-fluid">
    <!-- Filters -->
    <div class="filters">
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <input type="text" class="form-control" id="searchInput"
                 placeholder="작업번호 또는 차종 검색...">
        </div>

        <div class="col-md-2">
          <select class="form-select" id="statusFilter">
            <option value="">전체 상태</option>
            <option value="uploaded">업로드 완료</option>
            <option value="processing">처리 중</option>
            <option value="published">발행 완료</option>
          </select>
        </div>

        <div class="col-md-2">
          <input type="date" class="form-control" id="dateFilter">
        </div>

        <div class="col-md-3">
          <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="setSortOrder('date-desc')">
              <i class="bi bi-sort-down"></i> 최신순
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="setSortOrder('date-asc')">
              <i class="bi bi-sort-up"></i> 오래된순
            </button>
          </div>
        </div>

        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="applyFilters()">
            <i class="bi bi-search"></i> 검색
          </button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <h3 id="totalJobs">-</h3>
        <p>전체 작업</p>
      </div>
      <div class="stat-card">
        <h3 id="totalPhotos">-</h3>
        <p>전체 사진</p>
      </div>
      <div class="stat-card">
        <h3 id="thisMonthJobs">-</h3>
        <p>이번 달 작업</p>
      </div>
      <div class="stat-card">
        <h3 id="thisWeekJobs">-</h3>
        <p>이번 주 작업</p>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">로딩 중...</span>
      </div>
      <p class="mt-3">작업 목록을 불러오는 중...</p>
    </div>

    <!-- Jobs Grid -->
    <div id="jobsGrid" class="jobs-grid d-none"></div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state d-none">
      <i class="bi bi-inbox"></i>
      <h4>아직 작업이 없습니다</h4>
      <p class="text-muted">새 작업을 추가하려면 하단의 + 버튼을 클릭하세요</p>
    </div>
  </div>

  <!-- FAB Button -->
  <button class="fab-btn" onclick="goToUpload()">
    <i class="bi bi-plus-lg"></i>
  </button>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script type="module">
    import { requireAuth, displayUserProfile } from '../js/auth.js';
    import { fetchJobs, renderJobList } from '../js/gallery.js';

    // 로그인 확인
    const user = await requireAuth();
    if (!user) {
      throw new Error('로그인 필요');
    }

    // 사용자 프로필 표시
    await displayUserProfile('userProfile');

    // 전역 상태
    let allJobs = [];
    let currentFilters = {
      search: '',
      status: '',
      date: '',
      sort: 'date-desc'
    };

    // 작업 목록 로드
    async function loadJobs() {
      const loading = document.getElementById('loading');
      const jobsGrid = document.getElementById('jobsGrid');
      const emptyState = document.getElementById('emptyState');

      try {
        loading.classList.remove('d-none');
        jobsGrid.classList.add('d-none');
        emptyState.classList.add('d-none');

        allJobs = await fetchJobs(currentFilters);

        if (allJobs.length === 0) {
          emptyState.classList.remove('d-none');
        } else {
          jobsGrid.classList.remove('d-none');
          renderJobs(allJobs);
        }

        updateStats(allJobs);
      } catch (error) {
        console.error('작업 목록 로드 오류:', error);
        alert('작업 목록을 불러오는데 실패했습니다.');
      } finally {
        loading.classList.add('d-none');
      }
    }

    // 작업 렌더링
    function renderJobs(jobs) {
      const grid = document.getElementById('jobsGrid');

      const html = jobs.map(job => {
        const thumbnail = job.photos.find(p => p.category === 'before_car')?.thumbnail_url
                       || job.photos[0]?.thumbnail_url
                       || 'https://via.placeholder.com/300x200?text=No+Image';

        const photoCount = job.photos.length;
        const workDate = new Date(job.work_date).toLocaleDateString('ko-KR');

        return `
          <div class="job-card" onclick="viewJobDetail('${job.id}')">
            <img src="${thumbnail}" class="job-card-image" alt="${job.car_model}">
            <div class="job-card-body">
              <div class="job-number">${job.job_number}</div>
              <h5 class="mb-2">${job.car_model}</h5>
              ${job.location ? `<p class="text-muted small mb-0"><i class="bi bi-geo-alt"></i> ${job.location}</p>` : ''}
              <div class="job-meta">
                <span class="job-badge badge-photos">
                  <i class="bi bi-images"></i> ${photoCount}장
                </span>
                <span class="job-badge badge-date">
                  <i class="bi bi-calendar"></i> ${workDate}
                </span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      grid.innerHTML = html;
    }

    // 통계 업데이트
    function updateStats(jobs) {
      const totalJobs = jobs.length;
      const totalPhotos = jobs.reduce((sum, job) => sum + job.photos.length, 0);

      const now = new Date();
      const thisMonth = jobs.filter(job => {
        const date = new Date(job.work_date);
        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
      }).length;

      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const thisWeek = jobs.filter(job => new Date(job.work_date) >= weekAgo).length;

      document.getElementById('totalJobs').textContent = totalJobs;
      document.getElementById('totalPhotos').textContent = totalPhotos;
      document.getElementById('thisMonthJobs').textContent = thisMonth;
      document.getElementById('thisWeekJobs').textContent = thisWeek;
    }

    // 필터 적용
    window.applyFilters = function() {
      currentFilters.search = document.getElementById('searchInput').value.trim();
      currentFilters.status = document.getElementById('statusFilter').value;
      currentFilters.date = document.getElementById('dateFilter').value;

      let filtered = [...allJobs];

      // 검색
      if (currentFilters.search) {
        const term = currentFilters.search.toLowerCase();
        filtered = filtered.filter(job =>
          job.job_number.toLowerCase().includes(term) ||
          job.car_model.toLowerCase().includes(term)
        );
      }

      // 상태
      if (currentFilters.status) {
        filtered = filtered.filter(job => job.status === currentFilters.status);
      }

      // 날짜
      if (currentFilters.date) {
        filtered = filtered.filter(job => job.work_date === currentFilters.date);
      }

      // 정렬
      if (currentFilters.sort === 'date-desc') {
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      } else {
        filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      }

      renderJobs(filtered);
    };

    // 정렬 변경
    window.setSortOrder = function(order) {
      currentFilters.sort = order;

      // 버튼 활성화 상태 변경
      document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('button').classList.add('active');

      applyFilters();
    };

    // 작업 상세 보기
    window.viewJobDetail = function(jobId) {
      window.location.href = `/job-detail.html?id=${jobId}`;
    };

    // 업로드 페이지로 이동
    window.goToUpload = function() {
      window.location.href = '/public/upload.html';
    };

    // 초기 로드
    loadJobs();

    console.log('✅ Gallery page initialized');
  </script>

</body>
</html>
