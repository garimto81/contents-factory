<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ÏÇ¨ÏßÑ Ï¥¨ÏòÅ - Photo Factory</title>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const hash = typeof __GIT_HASH__ !== 'undefined' ? __GIT_HASH__ : 'dev';
      const msg = typeof __GIT_MESSAGE__ !== 'undefined' ? __GIT_MESSAGE__ : '';
      document.title = `ÏÇ¨ÏßÑ Ï¥¨ÏòÅ [${hash}] ${msg.slice(0, 20)}`;
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #f8f9fa;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .app-container {
      max-width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: white;
    }

    /* Header - Fixed */
    .header {
      flex-shrink: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.2rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-back {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      font-size: 1.2rem;
    }

    /* Title Input */
    .title-section {
      flex-shrink: 0;
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }

    .title-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 1.1rem;
      border: 2px solid #667eea;
      border-radius: 12px;
      outline: none;
      transition: all 0.3s;
    }

    .title-input:focus {
      border-color: #764ba2;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    /* Main Content - Scrollable */
    .main-content {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px;
    }

    /* Category Tabs */
    .category-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 15px;
      margin-bottom: 20px;
      scrollbar-width: none;
    }

    .category-tabs::-webkit-scrollbar {
      display: none;
    }

    .category-tab {
      flex-shrink: 0;
      padding: 10px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      background: white;
      font-size: 0.9rem;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .category-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .category-tab .count {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 5px;
      font-size: 0.8rem;
    }

    .category-tab.active .count {
      background: rgba(255,255,255,0.3);
    }

    /* PRD-0003: Camera Button - 150px+ height */
    .camera-btn {
      width: 100%;
      min-height: 180px; /* PRD-0003: height -> min-height */
      max-width: 500px;
      margin: 0 auto 20px;
      border: 3px dashed #667eea;
      border-radius: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .camera-btn:hover, .camera-btn:active {
      background: linear-gradient(135deg, #e7f1ff 0%, #d4e6ff 100%);
      border-color: #764ba2;
      transform: scale(1.02);
    }

    .camera-btn i {
      font-size: 3.5rem;
      color: #667eea;
      margin-bottom: 12px;
    }

    .camera-btn span {
      font-size: 1.2rem;
      font-weight: 600;
      color: #667eea;
    }

    .camera-btn small {
      font-size: 0.9rem;
      color: #888;
      margin-top: 5px;
    }

    /* PRD-0003: Mobile-specific size */
    @media (max-width: 768px) {
      .camera-btn {
        min-height: 200px; /* PRD-0003: Mobile 200px */
      }

      .camera-btn i {
        font-size: 4rem;
      }

      .camera-btn span {
        font-size: 1.3rem;
      }
    }

    /* Gallery Button (for testing / desktop) */
    .gallery-btn {
      width: 100%;
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 15px 20px;
      border: 2px solid #adb5bd;
      border-radius: 12px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .gallery-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }

    .gallery-btn i {
      font-size: 1.3rem;
      color: #6c757d;
    }

    .gallery-btn span {
      font-size: 1rem;
      color: #495057;
    }

    /* PRD-0003: Photos Summary Button (replaces grid) */
    .photos-summary-btn {
      width: 100%;
      padding: 16px 20px;
      margin-top: 15px;
      border: 2px solid #667eea;
      border-radius: 12px;
      background: white;
      font-size: 1rem;
      font-weight: 600;
      color: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .photos-summary-btn:hover {
      background: #f8f9fa;
    }

    .photos-summary-btn .badge {
      background: #28a745;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
    }

    .photos-summary-btn.empty {
      border-color: #ccc;
      color: #888;
    }

    /* Footer - Fixed */
    .footer {
      flex-shrink: 0;
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* PRD-0003: Photos Modal */
    .photos-modal .modal-content {
      border-radius: 20px 20px 0 0;
    }

    .photos-modal .modal-header {
      border-bottom: none;
      padding: 20px;
    }

    .photos-modal .modal-title {
      font-weight: 600;
      color: #333;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 0 20px 20px;
    }

    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      background: #f0f0f0;
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-item .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .photo-item .category-badge {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
    }

    /* Hidden file input */
    .hidden-input {
      display: none;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 15px;
      font-size: 1rem;
      color: #666;
    }
  </style>
</head>
<body>

  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <button class="btn-back" onclick="location.href='index.html'">
        <i class="bi bi-arrow-left"></i>
      </button>
      <h1><i class="bi bi-camera-fill"></i> ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</h1>
      <div style="width: 40px;"></div>
    </div>

    <!-- Title Input -->
    <div class="title-section">
      <input type="text" class="title-input" id="job-title" placeholder="Ï∞®Îüâ Î™®Îç∏ ÏûÖÎ†• (Ïòà: Ï†úÎÑ§ÏãúÏä§ G80)">
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Category Tabs -->
      <div class="category-tabs">
        <button class="category-tab active" data-category="before_car">
          ÏûÖÍ≥† <span class="count" id="count-before_car">0</span>
        </button>
        <button class="category-tab" data-category="before_wheel">
          Î¨∏Ï†ú <span class="count" id="count-before_wheel">0</span>
        </button>
        <button class="category-tab" data-category="during">
          Í≥ºÏ†ï <span class="count" id="count-during">0</span>
        </button>
        <button class="category-tab" data-category="after_wheel">
          Ìï¥Í≤∞ <span class="count" id="count-after_wheel">0</span>
        </button>
        <button class="category-tab" data-category="after_car">
          Ï∂úÍ≥† <span class="count" id="count-after_car">0</span>
        </button>
      </div>

      <!-- Camera Button (PRD-0003: 150px+) -->
      <button class="camera-btn" id="camera-btn">
        <i class="bi bi-camera-fill"></i>
        <span>Ïπ¥Î©îÎùºÎ°ú Ï¥¨ÏòÅÌïòÍ∏∞</span>
        <small id="current-category-label">ÏûÖÍ≥† ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</small>
      </button>

      <!-- Gallery Button (for testing / desktop) -->
      <button class="gallery-btn" id="gallery-btn">
        <i class="bi bi-folder2-open"></i>
        <span>Í∞§Îü¨Î¶¨/Ìè¥ÎçîÏóêÏÑú ÏÑ†ÌÉù</span>
      </button>

      <!-- Hidden File Inputs -->
      <input type="file" accept="image/*" capture="environment" class="hidden-input" id="camera-input" multiple>
      <input type="file" accept="image/*" class="hidden-input" id="gallery-input" multiple>

      <!-- PRD-0003: Photos Summary Button (instead of inline grid) -->
      <button class="photos-summary-btn empty" id="photos-summary-btn" data-bs-toggle="modal" data-bs-target="#photosModal">
        <i class="bi bi-images"></i>
        Ï¥¨ÏòÅÌïú ÏÇ¨ÏßÑ <span class="badge" id="total-photo-count">0</span>Ïû• Î≥¥Í∏∞
      </button>
    </div>

    <!-- Footer -->
    <div class="footer">
      <button class="submit-btn" id="submit-btn" disabled>
        <i class="bi bi-cloud-upload"></i>
        ÏûëÏóÖ Ï†ÄÏû•ÌïòÍ∏∞
      </button>
    </div>
  </div>

  <!-- PRD-0003: Photos Modal -->
  <div class="modal fade photos-modal" id="photosModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ï¥¨ÏòÅÌïú ÏÇ¨ÏßÑ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="photos-grid" id="photos-grid">
            <!-- Photos will be rendered here -->
          </div>
          <p class="text-center text-muted" id="no-photos-message">ÏïÑÏßÅ Ï¥¨ÏòÅÌïú ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Ï†ÄÏû• Ï§ë...</div>
  </div>

  <!-- Photo Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content" style="background: rgba(0,0,0,0.95);">
        <div class="modal-header border-0">
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body d-flex align-items-center justify-content-center p-0">
          <img id="preview-image" src="" alt="Preview" style="max-width: 100%; max-height: 90vh; object-fit: contain;">
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { db } from '../js/db.js';
    import { jobsAPI, photosAPI, generateJobNumber, validateFile } from '../js/db-api.js';
    import { jobState } from '../js/utils/state.js';
    import { escapeHtml, sanitizeFilename } from '../js/utils/sanitizer.js';
    import { processImage, getCompressionStats } from '../js/utils/image-compressor.js';

    // Constants
    const MAX_TOTAL_PHOTOS = 50;

    // Categories configuration
    const CATEGORIES = {
      before_car: { label: 'ÏûÖÍ≥†', description: 'Ï∞®Îüâ ÏûÖÍ≥† Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ' },
      before_wheel: { label: 'Î¨∏Ï†ú', description: 'ÏÜêÏÉÅÎêú Ìú† ÌÅ¥Î°úÏ¶àÏóÖ' },
      during: { label: 'Í≥ºÏ†ï', description: 'ÏûëÏóÖ Ï§ë ÏÇ¨ÏßÑ' },
      after_wheel: { label: 'Ìï¥Í≤∞', description: 'Î≥µÏõêÎêú Ìú† ÌÅ¥Î°úÏ¶àÏóÖ' },
      after_car: { label: 'Ï∂úÍ≥†', description: 'ÏôÑÎ£åÎêú Ï∞®Îüâ Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ' }
    };

    // Current state
    let currentCategory = 'before_car';
    let photos = {
      before_car: [],
      before_wheel: [],
      during: [],
      after_wheel: [],
      after_car: []
    };

    // DOM Elements
    const cameraBtn = document.getElementById('camera-btn');
    const cameraInput = document.getElementById('camera-input');
    const galleryBtn = document.getElementById('gallery-btn');
    const galleryInput = document.getElementById('gallery-input');
    const categoryTabs = document.querySelectorAll('.category-tab');
    const submitBtn = document.getElementById('submit-btn');
    const photosGrid = document.getElementById('photos-grid');
    const photosSummaryBtn = document.getElementById('photos-summary-btn');
    const noPhotosMessage = document.getElementById('no-photos-message');
    const loadingOverlay = document.getElementById('loading-overlay');
    const jobTitle = document.getElementById('job-title');

    // Initialize
    async function init() {
      // Load saved state
      const savedState = jobState.get();
      if (savedState.carModel) {
        jobTitle.value = savedState.carModel;
      }

      // Load photos with image data from IndexedDB (not just metadata)
      try {
        const photosWithData = await jobState.getPhotosWithData();
        // photosWithData is grouped by category from IndexedDB
        Object.keys(CATEGORIES).forEach(category => {
          const categoryPhotos = photosWithData.filter(p => p.category === category);
          categoryPhotos.forEach(photo => {
            // Only add if has actual image data
            if (photo.image_data || photo.thumbnail_data) {
              photos[category].push({
                id: photo.id,
                category: category,
                thumbnail: photo.thumbnail_data || photo.image_data,
                fullImage: photo.image_data,
                filename: photo.file_name,
                size: photo.file_size,
                createdAt: photo.created_at
              });
            }
          });
        });
      } catch (error) {
        console.error('Failed to load photos from IndexedDB:', error);
      }

      // Setup event listeners
      cameraBtn.addEventListener('click', () => cameraInput.click());
      cameraInput.addEventListener('change', handleFileSelect);
      galleryBtn.addEventListener('click', () => galleryInput.click());
      galleryInput.addEventListener('change', handleFileSelect);
      submitBtn.addEventListener('click', handleSubmit);

      categoryTabs.forEach(tab => {
        tab.addEventListener('click', () => selectCategory(tab.dataset.category));
      });

      // Update UI
      updateCounts();
      updatePhotosGrid();
      updateSubmitButton();
    }

    // Select category
    function selectCategory(category) {
      currentCategory = category;

      categoryTabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
      });

      document.getElementById('current-category-label').textContent =
        `${CATEGORIES[category].label} ÏÇ¨ÏßÑ Ï¥¨ÏòÅ`;
    }

    // Handle file selection
    async function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;

      // Check total photo count limit
      const currentTotal = Object.values(photos).reduce((sum, arr) => sum + arr.length, 0);
      if (currentTotal + files.length > MAX_TOTAL_PHOTOS) {
        alert(`ÏµúÎåÄ ${MAX_TOTAL_PHOTOS}Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§. (ÌòÑÏû¨: ${currentTotal}Ïû•)`);
        cameraInput.value = '';
        galleryInput.value = '';
        return;
      }

      let successCount = 0;
      let errorCount = 0;
      let totalSaved = 0;

      // Show loading for multiple files
      if (files.length > 1) {
        loadingOverlay.querySelector('.loading-text').textContent = `Ï≤òÎ¶¨ Ï§ë... (0/${files.length})`;
        loadingOverlay.classList.remove('hidden');
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        // Update loading text
        if (files.length > 1) {
          loadingOverlay.querySelector('.loading-text').textContent = `Ï≤òÎ¶¨ Ï§ë... (${i + 1}/${files.length})`;
        }

        try {
          // Validate file (size, type)
          validateFile(file);

          // Process image with compression + EXIF fix + thumbnail generation
          // Uses browser-image-compression for:
          // - EXIF orientation correction (fixes rotated mobile photos)
          // - Image compression (reduces file size)
          // - Web Worker non-blocking processing
          const { image_data, thumbnail_data, file_size, original_size } = await processImage(file);

          // Log compression stats
          const stats = getCompressionStats(original_size, file_size);
          console.log(`üì∏ ${file.name}: ${stats.originalMB}MB ‚Üí ${stats.compressedKB}KB (${stats.reductionPercent}% Ï†àÏïΩ)`);
          totalSaved += stats.savedBytes;

          const photoId = Date.now() + Math.random();

          // Add to IndexedDB via jobState (images stored in IndexedDB, metadata in LocalStorage)
          await jobState.addPhoto(currentCategory, {
            image_data,
            thumbnail_data,
            file_name: sanitizeFilename(file.name),
            file_size
          });

          // Keep local copy for UI display (in-memory only)
          const photoData = {
            id: photoId,
            category: currentCategory,
            thumbnail: thumbnail_data,
            fullImage: image_data,
            filename: sanitizeFilename(file.name),
            size: file_size,
            createdAt: Date.now()
          };

          photos[currentCategory].push(photoData);

          // Incremental DOM update (no full re-render)
          addPhotoToGrid(photoData);
          successCount++;
        } catch (error) {
          console.error('Failed to process photo:', error);
          errorCount++;
          // Show specific validation error messages
          if (error.name === 'ValidationError' || error.field) {
            alert(error.message);
          }
        }
      }

      // Hide loading
      loadingOverlay.classList.add('hidden');
      loadingOverlay.querySelector('.loading-text').textContent = 'Ï†ÄÏû• Ï§ë...';

      // Show summary
      if (successCount > 0 && totalSaved > 0) {
        const savedMB = (totalSaved / 1024 / 1024).toFixed(1);
        console.log(`‚úÖ Ï¥ù ${successCount}Ïû• ÏóÖÎ°úÎìú, ${savedMB}MB Ï†àÏïΩÎê®`);
      }

      if (errorCount > 0 && successCount > 0) {
        alert(`${successCount}Ïû• ÏóÖÎ°úÎìú ÏÑ±Í≥µ, ${errorCount}Ïû• Ïã§Ìå®`);
      } else if (errorCount > 0 && successCount === 0) {
        alert('Î™®Îì† ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }

      // Clear inputs for re-selection
      cameraInput.value = '';
      galleryInput.value = '';

      // Update non-photo state (carModel only)
      jobState.update({ carModel: jobTitle.value });

      // Update UI (counts only - photos added incrementally above)
      updateCounts();
      updateSubmitButton();
    }

    // Update photo counts
    function updateCounts() {
      let totalCount = 0;

      Object.keys(CATEGORIES).forEach(category => {
        const count = photos[category].length;
        document.getElementById(`count-${category}`).textContent = count;
        totalCount += count;
      });

      document.getElementById('total-photo-count').textContent = totalCount;

      // Update summary button style
      if (totalCount > 0) {
        photosSummaryBtn.classList.remove('empty');
      } else {
        photosSummaryBtn.classList.add('empty');
      }
    }

    // Create a single photo element (reusable helper)
    function createPhotoElement(photo) {
      const div = document.createElement('div');
      div.className = 'photo-item';
      div.dataset.photoId = photo.id;
      div.style.cursor = 'pointer';

      const img = document.createElement('img');
      img.src = photo.thumbnail;
      img.alt = 'Photo';

      // Click to preview
      div.addEventListener('click', () => {
        showPreview(photo.fullImage || photo.thumbnail);
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '<i class="bi bi-x"></i>';
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deletePhoto(photo.category, photo.id);
      });

      const badge = document.createElement('span');
      badge.className = 'category-badge';
      badge.textContent = photo.categoryLabel;

      div.appendChild(img);
      div.appendChild(deleteBtn);
      div.appendChild(badge);

      return div;
    }

    // Show photo preview in fullscreen modal
    function showPreview(imageSrc) {
      const previewImage = document.getElementById('preview-image');
      previewImage.src = imageSrc;
      const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
      previewModal.show();
    }

    // Update photos grid in modal (full rebuild - use sparingly)
    function updatePhotosGrid() {
      const allPhotos = [];

      Object.keys(CATEGORIES).forEach(category => {
        photos[category].forEach(photo => {
          allPhotos.push({ ...photo, categoryLabel: CATEGORIES[category].label });
        });
      });

      if (allPhotos.length === 0) {
        photosGrid.innerHTML = '';
        noPhotosMessage.style.display = 'block';
        return;
      }

      noPhotosMessage.style.display = 'none';

      // Use DocumentFragment for batch DOM insertion
      const fragment = document.createDocumentFragment();
      allPhotos.forEach(photo => {
        fragment.appendChild(createPhotoElement(photo));
      });

      photosGrid.innerHTML = '';
      photosGrid.appendChild(fragment);
    }

    // Add single photo to grid (incremental update)
    function addPhotoToGrid(photo) {
      noPhotosMessage.style.display = 'none';
      const element = createPhotoElement({
        ...photo,
        categoryLabel: CATEGORIES[photo.category].label
      });
      photosGrid.appendChild(element);
    }

    // Remove single photo from grid (incremental update)
    function removePhotoFromGrid(photoId) {
      const element = photosGrid.querySelector(`[data-photo-id="${photoId}"]`);
      if (element) {
        element.remove();
      }

      // Show empty message if no photos left
      const totalCount = Object.values(photos).reduce((sum, arr) => sum + arr.length, 0);
      if (totalCount === 0) {
        noPhotosMessage.style.display = 'block';
      }
    }

    // Delete photo
    async function deletePhoto(category, photoId) {
      // Find and remove from local photos array
      const index = photos[category].findIndex(p => p.id == photoId);
      if (index === -1) return;

      // Get the photo data before removing
      const photoToDelete = photos[category][index];

      // Remove from local array
      photos[category].splice(index, 1);

      // Remove from IndexedDB directly using photo ID
      try {
        const { deleteTempPhoto } = await import('../js/db.js');
        await deleteTempPhoto(photoId);
      } catch (error) {
        console.error('Failed to delete photo from IndexedDB:', error);
      }

      // Incremental DOM update (no full re-render)
      removePhotoFromGrid(photoId);
      updateCounts();
      updateSubmitButton();
    }

    // Update submit button state
    function updateSubmitButton() {
      const totalCount = Object.values(photos).reduce((sum, arr) => sum + arr.length, 0);
      const hasTitle = jobTitle.value.trim().length > 0;

      submitBtn.disabled = !(totalCount > 0 && hasTitle);
    }

    // Handle submit
    async function handleSubmit() {
      const carModel = jobTitle.value.trim();
      if (!carModel) {
        alert('Ï∞®Îüâ Î™®Îç∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const totalPhotos = Object.values(photos).reduce((sum, arr) => sum + arr.length, 0);
      if (totalPhotos === 0) {
        alert('ÏµúÏÜå 1Ïû•Ïùò ÏÇ¨ÏßÑÏùÑ Ï¥¨ÏòÅÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      // Show loading
      loadingOverlay.classList.remove('hidden');

      try {
        // Generate job number
        const { data: jobNumber } = await generateJobNumber();

        // Create job
        const { data: job, error: jobError } = await jobsAPI.insert({
          job_number: jobNumber,
          work_date: new Date().toISOString().split('T')[0],
          car_model: carModel,
          technician_id: 'local-user',
          status: 'uploaded'
        });

        if (jobError) throw new Error(jobError);

        // Save photos using bulk insert (single DB operation)
        const allPhotos = [];
        let sequence = 0;

        for (const category of Object.keys(CATEGORIES)) {
          for (const photo of photos[category]) {
            sequence++;
            allPhotos.push({
              job_id: job.id,
              category,
              sequence,
              thumbnail_data: photo.thumbnail,
              image_data: photo.fullImage,
              filename: photo.filename
            });
          }
        }

        if (allPhotos.length > 0) {
          await photosAPI.insert(allPhotos);  // Single bulk insert
        }

        // Clear state
        jobState.reset();

        // Success
        alert(`ÏûëÏóÖÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\nÏûëÏóÖÎ≤àÌò∏: ${jobNumber}`);
        location.href = 'gallery.html';

      } catch (error) {
        console.error('Failed to save job:', error);
        alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
      } finally {
        loadingOverlay.classList.add('hidden');
      }
    }

    // Title input change
    jobTitle.addEventListener('input', () => {
      jobState.update({ carModel: jobTitle.value });
      updateSubmitButton();
    });

    // Initialize app
    init();
  </script>

</body>
</html>
